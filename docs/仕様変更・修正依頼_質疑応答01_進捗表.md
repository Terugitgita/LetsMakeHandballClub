# 仕様変更・修正依頼 質疑応答01 進捗管理表

---

## 概要

| 項目 | 内容 |
|------|------|
| プロジェクト | ズッキュン中学物語 デバッグ用CLI |
| 開始日 | 2025-12-31 |
| 実行環境 | Node.js |
| テスト形式 | 自動テストスイート（全パターン網羅） |

---

## 決定事項

| 項目 | 決定内容 |
|------|----------|
| 実行環境 | Node.js |
| テスト対象 | 全機能 |
| テスト粒度 | 細かい粒度（全組み合わせ、数千件） |
| 結果フォーマット | 両方（.md + .json） |
| PDCA範囲 | 失敗原因の自動分析 + 修正案の提示 |
| 実行方法 | 手動実行（`node run-tests.js`） |

---

## 既知バグ

| ID | バグ内容 | ステータス |
|----|----------|-----------|
| BUG-001 | 練習中に動かなくなる | [ ] 未調査 |
| BUG-002 | ピボットへのパスが発動しない | [ ] 未調査 |
| BUG-003 | フィールドプレーヤーが6mラインに入る | [ ] 未調査 |
| BUG-004 | ドリブル後に主語（誰が）が消える | [ ] 未調査 |
| BUG-005 | ピボットシュート後フリーズ（準決勝で発生） | [ ] 未調査 |
| BUG-006 | ピボットにパス指定してもパスされずシュートされる | [ ] 未調査 |

---

## 実装タスク

### Phase 1: 基盤構築

| No | タスク | ファイル | ステータス |
|----|--------|----------|-----------|
| 1-1 | ブラウザAPIモック作成 | `cli/browser-mock.js` | [x] 完了 |
| 1-2 | テスト実行エンジン作成 | `cli/test-runner.js` | [x] 完了 |
| 1-3 | テストパターン自動生成 | `cli/full-test-generator.js` | [x] 完了（約3,000件） |

### Phase 2: テストケース実装

| No | タスク | ファイル | ステータス |
|----|--------|----------|-----------|
| 2-1 | 練習システムテスト | `cli/full-test-generator.js` | [x] 完了（TR系約1,950件） |
| 2-2 | 試合シミュレーションテスト | `cli/full-test-generator.js` | [x] 完了（MT系約800件） |
| 2-3 | トーナメント進行テスト | `cli/full-test-generator.js` | [x] 完了（TN系約100件） |
| 2-4 | エース/ギアセカンドテスト | `cli/full-test-generator.js` | [x] 完了（AC系約50件） |
| 2-5 | バグ回帰テスト | `cli/full-test-generator.js` | [x] 完了（BUG系約50件） |

### Phase 3: 結果出力・PDCA

| No | タスク | ファイル | ステータス |
|----|--------|----------|-----------|
| 3-1 | Markdown結果出力 | `cli/report-generator.js` | [x] 完了 |
| 3-2 | JSON結果出力 | `cli/report-generator.js` | [x] 完了 |
| 3-3 | PDCA分析機能 | `cli/pdca-analyzer.js` | [x] 完了 |

### Phase 4: 全パターンテスト実行

| No | タスク | 内容 | ステータス |
|----|--------|----------|-----------|
| 4-1 | 全パターンテスト実行 | `node cli/run-tests.js --full` | [x] 完了（2,001件成功） |
| 4-2 | 失敗テスト分析 | PDCA分析レポート生成 | [x] 完了 |
| 4-3 | バグ修正 | P→Pテストロジック修正 | [x] 完了 |
| 4-4 | 連番管理機能追加 | --version=XX オプション | [x] 完了 |
| 4-5 | 初期テストパターン再作成 | basic-test-generator.js | [x] 完了 |

### Phase 5: UI改善・機能追加（2026-01-01）

| No | タスク | 内容 | ステータス |
|----|--------|------|-----------|
| 5-1 | スクロール修正 | タッチ操作で上に戻れない問題 | [x] 完了 |
| 5-2 | 練習メニュー表形式化 | アイコン付き表（メニュー+能力上昇値） | [x] 完了 |
| 5-3 | 作戦セット機能 | 新規作成/編集/削除、平日・試合開始前にUI追加 | [x] 完了 |
| 5-4 | ドリブル主語表示 | 簡略形「CB: ドリブル → シュート」 | [x] 完了 |
| 5-5 | 勝敗画面透明化 | 文字ボックス背景50%透明+文字影 | [x] 完了 |
| 5-6 | 作戦デフォルト保持 | 前回試合の作戦を次試合にも適用 | [x] 完了 |
| 5-7 | 不要テキスト削除 | 勝利画面「次の試合へ進みます」削除 | [x] 完了 |
| 5-8 | エース表示 | 作戦立案中にオーラ/枠線でエース表示 | [x] 完了 |
| 5-9 | ピボットバグ修正 | シュート後フリーズ、パス無視問題 | [x] 完了 |

### Phase 6: 追加修正・機能改善（2026-01-01）

| No | タスク | 内容 | ステータス |
|----|--------|------|-----------|
| P10 | BGM継続再生 | 画面遷移でリセットせず試合開始まで継続 | [x] 完了 |
| P11 | 勝利画面スタイル | 透明度50%+黒文字+白い影、勝利/敗北で色変更 | [x] 完了 |
| P12 | 能力値横並び | 練習メニュー画面で現在値を横並び表示 | [x] 完了 |
| P13 | 総合練習バグ | 最大値ではなく最小値になる問題 | [x] 完了 |
| P14/15/16 | ピボットパスバグ | ドリブル後Pへのパスがスキップされる | [x] 完了（デバッグログ追加） |
| P17 | 作戦変更UIバグ | 変更確定後に次の作戦が立てられない | [x] 完了 |
| P18 | インターセプトフリーズ | 再挑戦後2回目でスコア異常+フリーズ | [!] 問題継続 |
| P19 | 試合前に戻るボタン | 設定画面から試合前画面に戻る機能 | [!] 問題継続 |
| P20 | iPhone音楽再生 | iOS WebAudio制限対応 | [x] 完了 |

### Phase 7: 追加修正・テスト生成（2026-01-01）

| No | タスク | 内容 | ステータス |
|----|--------|------|-----------|
| P18(継続) | RBシュート時フリーズ | teams.js:12のundefinedエラー修正（ラウンド範囲チェック追加） | [x] 完了 |
| P19(継続) | 試合前に戻るボタン | MATCH/MATCH_SETUP両画面で表示、デバッグログ追加 | [x] 完了 |
| P21 | 今日の一句 | 外部ファイル読み込み（Random_Senryu_01-03.txt） | [x] 完了 |
| P22 | 全日総合練習 | 総合練習もweeklyTrainingに記録して次回計算に反映 | [x] 完了 |
| P24 | 試合パターンテスト | 全網羅版生成プログラム（味方6pos×敵54パターン×1-5手） | [x] 完了 |

### Phase 8: 試合パターンテスト本格実装（2026-01-01）

| No | タスク | 内容 | ステータス |
|----|--------|------|-----------|
| P25-1 | 試合ロジック組み込み | SyncMatchSimulator作成（同期版シミュレーター） | [x] 完了 |
| P25-2 | テスト検証項目実装 | パス/ドリブル/シュート実行、インターセプト、フリーズ検知 | [x] 完了 |
| P25-3 | エラー出力最適化 | エラーグループ化、スタックトレース、作戦説明出力 | [x] 完了 |
| P25-4 | テスト実行・デバッグ | ユーザー実行待ち | [x] 完了 |
| P26 | 作戦編集時passToバグ修正 | screens.js編集時にpassTo必須チェック追加 | [x] 完了 |
| P27 | 作戦構造検証追加 | validateTactics関数追加（passTo/方向/距離/シュート終端検証） | [x] 完了 |

### Phase 9: 高手数テスト対応（2026-01-01）

| No | タスク | 内容 | ステータス |
|----|--------|------|-----------|
| P28 | runSync()同期テスト実装 | MatchSimulator.runSync()を使った同期テスト | [x] 完了 |
| P29 | テスト検証バグ修正 | score_change順序、ballAnimatingリセット、境界チェック緩和 | [x] 完了 |
| P30 | ログ出力改善 | docs/Test_Logに自動連番出力（実行結果01.txt...） | [x] 完了 |
| P31 | パターン数高速計算 | 数式でパターン数を瞬時計算（T(n)漸化式） | [x] 完了 |
| P32 | ランダムサンプリング | 高手数用ランダムパターン生成（イテレーション不要） | [x] 完了 |
| P33 | テスト共通化 | runSingleTest()関数でロジック統一 | [x] 完了 |
| P34 | 10手テスト実行 | 6-10手テスト実行、エラー発見 | [x] 完了 |
| P35 | ドリブル検証バグ修正 | verifyActionLog関数の重複マッチングバグ修正 | [x] 完了 |
| P36 | 修正後テスト確認 | 6-10手全テスト成功（各1,000件、エラー0件） | [x] 完了 |
| P37 | 全日ボタン表示条件修正 | currentRound>=4条件削除、全ラウンドで表示 | [x] 完了 |
| P38 | 決勝相手固定 | K航拿がAI戦で常勝、必ず決勝に到達 | [x] 完了 |
| P39 | 決勝戦特殊判定 | パス/ドリブル67%カット、シュートFP67%+GK100%ブロック | [x] 完了 |
| P40 | タイトル背景画像 | 画像ロード完了後に背景を再適用 | [x] 完了 |
| P41 | ファイナルボス強化 | 敵速度3倍、パス線上に立ちはだかるAI追加 | [x] 完了 |

---

## 質疑応答結果（Phase 7）

| 質問 | 回答 |
|------|------|
| Q23: 全日総合練習の期待動作 | A) 1日ずつ能力値更新 + C) 最終能力値を事前計算表示 |
| Q24-1: テストパターン範囲 | D) 1手～5手の全組み合わせ（数千パターン） |
| Q24-2: 確認したい期待動作 | D) 上記すべて + パス出し手/受け手、インターセプト、画面遷移の正確性 |
| Q24-3: 異常の定義 | D) 上記すべて（エラー、作戦不一致、フリーズ） |

## 質疑応答結果（Phase 8）

| 質問 | 回答 |
|------|------|
| Q25-1: テスト検証項目 | G) 上記すべて（作戦実行、インターセプト、得点、画面遷移、フリーズ、例外） |
| Q25-2: 出力形式 | Claude Codeがエラー状況を把握・対応できる必要十分な情報を最高効率で出力 |
| Q25-3: 実行時間上限 | D) 時間制限なし |
| 並列実行 | ❌ 断念（グローバル状態依存のため不可）→シングルスレッド |

---

## テスト結果サマリ

| バージョン | モード | テスト数 | 成功 | 失敗 | 成功率 |
|-----------|--------|----------|------|------|--------|
| 01 | Basic | ~150件 | - | - | 未実行 |
| 02 | Full | 2,001件 | 2,001 | 0 | 100% |
| 05 | Match 3手のみ | 534件 | 534 | 0 | 100% |
| 06 | Match 1-3手 | 2,680件 | 2,680 | 0 | 100% |
| 13 | Match 6手 | 1,000件 | 1,000 | 0 | 100% |
| 14 | Match 7手 | 1,000件 | 1,000 | 0 | 100% |
| 15 | Match 8手 | 1,000件 | 1,000 | 0 | 100% |
| 16 | Match 9手 | 1,000件 | 1,000 | 0 | 100% |
| 17 | Match 10手 | 1,000件 | 1,000 | 0 | 100% |

---

## テストパターン見積もり

| カテゴリ | 組み合わせ | Basic | Full |
|----------|-----------|-------|------|
| 練習システム (TR) | 性格×方針×練習 | ~60件 | ~1,500件 |
| 試合シミュレーション (MT) | ポジション×地域 | ~30件 | ~300件 |
| トーナメント (TN) | ラウンド×進行 | ~15件 | ~100件 |
| エース/ギアセカンド (AC) | ポジション×覚醒 | ~15件 | ~50件 |
| セーブ/ロード (SL) | データ永続性 | ~10件 | ~30件 |
| バグ回帰 (BUG) | 既知バグ確認 | ~20件 | ~30件 |
| **合計** | | **~150件** | **~2,000件** |

---

## ファイル構成

```
LetsMakeHandballClub/
├── cli/
│   ├── package.json            # Node.js設定（ES modules）
│   ├── browser-mock.js         # ブラウザAPIモック
│   ├── test-runner.js          # テスト実行エンジン
│   ├── basic-test-generator.js # 初期テストパターン（~150件）
│   ├── full-test-generator.js  # 全パターン自動生成（~2,000件）
│   ├── run-tests.js            # メインエントリポイント
│   ├── report-generator.js     # 結果出力（MD/JSON）
│   ├── pdca-analyzer.js        # PDCA分析
│   └── pdca-cli.js             # PDCA CLIコマンド
├── docs/
│   ├── All_Pattern_Test_XX.md  # テスト結果（Markdown）
│   ├── test-results-XX.json    # テスト結果（JSON）
│   └── pdca-report-XX.md       # PDCA分析レポート
└── js/
    └── (既存ファイル)
```

## コマンド一覧

| コマンド | 説明 |
|----------|------|
| `node cli/run-tests.js --basic --version=01` | 初期テスト実行 |
| `node cli/run-tests.js --full --version=02` | フルテスト実行 |
| `node cli/pdca-cli.js --version=01` | PDCA分析（初期） |
| `node cli/pdca-cli.js --version=02` | PDCA分析（フル） |
| `node cli/match-pattern-test.js 3 n1000` | 試合パターンテスト（1-3手、各最大1000件） |
| `node cli/match-pattern-test.js 10 n500` | 試合パターンテスト（1-10手、各最大500件） |
| `node cli/match-pattern-test.js 3! n500` | 試合パターンテスト（3手のみ、最大500件） |

### Phase 10: UI改善・ゲームバランス調整（2026-01-02）

| No | タスク | 内容 | ステータス |
|----|--------|------|-----------|
| P42 | サブタイトル変更 | 「死に戻りチートで絶対優勝！？」視覚的に強調 | [x] 完了 |
| P43 | 死に戻り表示 | インターセプト時「死に戻り発動！」表示、「残り死に戻り回数」に変更 | [x] 完了 |
| P44 | 全日練習向上値表示 | 1日ずつ計算した合計パス/ドリブル/シュート向上値を表示 | [x] 完了 |
| P45 | GKセーブ確率追加 | 通常試合でGKが追いついたら止める（確率=(FP確率+100%)/2） | [x] 完了 |
| P46 | 作戦決定画面レイアウト | 地方+守備戦術を1行に、能力値を表形式、上に詰める | [x] 完了 |
| P47 | てぇでぇず戦維持 | 現状維持（全FP高速、GK100%セーブ、パス/ドリブル67%カット） | [x] 確認済 |
| Q26 | 通常試合FP動作改善 | 最も近いFPのみ2.5倍速でラインに移動、ボール接触時のみインターセプト | [x] 完了 |

---

## 質疑応答結果（Phase 10）

| 質問 | 回答 |
|------|------|
| Q26: 通常試合FP動作 | B) + C)。最も近いFPのみ2〜3倍速反応、ボールに追いついた時のみインターセプト |
| P45追加要件 | 通常試合でもGKがシュートに追いついたら止める（確率=(FP確率+100%)/2） |
| P42補足 | 「死に戻り」を視覚的に強調 |
| P44補足 | 1日ずつ総合練習を選択した合計結果（単純掛け算ではない） |
| P46補足 | 表示を上に詰める |

---

### Phase 11: UI改善・ゲームバランス調整（2026-01-02 継続）

| No | タスク | 内容 | ステータス |
|----|--------|------|-----------|
| P42 | サブタイトル背景 | 50%透明度背景追加 | [x] 完了 |
| P43(継続) | 死に戻り回数表示 | 背景ボックス削除、中央揃え | [x] 完了 |
| P44(継続) | 全日計算改善 | 最弱パラメータ入れ替わりを考慮 | [x] 完了 |
| P45(継続) | GKセーブ判定改善 | GKが追いついた時点で判定 | [x] 完了 |
| P46(継続) | 表ラベル変更 | 「ズッキュン中学」「相手チーム名」 | [x] 完了 |
| P47(継続) | てぇでぇず戦GK | シュート目標に必ず到達、100%阻止 | [x] 完了 |
| P48 | インターセプト表示 | 「xxのyyを相手zzが止めた！」形式 | [x] 完了 |
| P49 | ふっとびアニメ | 成功時、線上の敵がノックバック | [x] 確認済（既存実装） |

---

## 質疑応答結果（Phase 11）

| 質問 | 回答 |
|------|------|
| Q27: GKセーブ判定 | C) シュート時のGK位置ではなく、GKが追いついた時点で判定 |
| Q28: インターセプト表示 | A) xx=ボール保持ポジション、yy=アクション種別、zz=インターセプトした敵ポジション |

---

### Phase 11.1: Phase 11修正（2026-01-02 継続）

| No | タスク | 内容 | ステータス |
|----|--------|------|-----------|
| P43(修正) | 中央揃え | `.attempts-row`にtext-align:center追加 | [x] 完了 |
| P44(修正) | 全日予告計算 | simulateGrowthでgrowthMultiplier/boycottEffect使用 | [x] 完了 |
| P45/P47(修正) | GKセーブ判定 | handleOpponentTakeoverではなくinterceptionCallbackを呼出 | [x] 完了 |
| P46(修正) | 表ラベル文字色 | `.team-label`にcolor:#333追加 | [x] 完了 |
| P48(修正) | ボール位置 | pause()時にボールをインターセプター位置に即座移動 | [x] 完了 |
| P49(修正) | ノックバック速度 | knockbackDuration: 2000→3333（60%速度） | [x] 完了 |
| P50 | 失敗作戦文字色 | `.tactic-failed`にcolor:#333追加 | [x] 完了 |

---

### Phase 11.2: Phase 11追加修正（2026-01-02 継続）

| No | タスク | 内容 | ステータス |
|----|--------|------|-----------|
| P43(追加) | 地方代表/守備傾向中央揃え | `.opponent-name-row`にtext-align:center追加 | [x] 完了 |
| P44(追加) | 全日計算ロジック刷新 | simulateAllDaysTrainingをapplyTrainingと同じmodifier適用に完全修正 | [x] 完了 |
| P45(追加) | GKセーブ条件緩和 | ライン上判定追加、マージン緩和(1.1→1.5)、ライン上は最低80%セーブ | [x] 完了 |
| P47(追加) | FP突破後GKセーブ | FP突破後も通常試合でGKセーブ判定を追加 | [x] 完了 |
| P49(追加) | シュート二重実行防止 | skipNextShootActionフラグでドリブル後の重複シュートをスキップ | [x] 完了 |

---

**最終更新:** 2026-01-02 (Phase 11.2 全タスク完了)
