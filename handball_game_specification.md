# ハンドボールシミュレーションゲーム「ズッキュン中学物語」仕様書

**重要**: 全てのゲームパラメータ、数値設定、ストーリー設定は「設定一覧.md」で管理されています。本仕様書は機能要件とゲームフローを定義し、具体的な数値は設定一覧を参照してください。

## 1. ゲーム概要
- **ジャンル**: ハンドボールシミュレーションゲーム（サカつくのハンドボール版）
- **プラットフォーム**: スマホWebブラウザ（ブラウザゲーム）
- **データ保存**: LocalStorage使用
- **目的**: 奈良市のズッキュン中学を全国優勝に導く

## 2. ゲームフロー

### 2.1 ゲーム開始
- 全国大会出場決定からスタート
- 初期能力値とキャプテンの性格・方針がランダム決定（リセマラ可能）
- タイトル画面：「ゲーム開始」「続きから」

### 2.2 週間スケジュール
- **月〜金**: 練習日（練習メニュー選択）
- **土曜**: 全国大会試合日
- **日曜**: 休養日（自動進行）

### 2.3 トーナメント進行
- 全48チーム（実在の47都道府県 + 架空の「K航拿」）
- 「てぇでぇ's学園」（K航拿代表）は最強シード枠
- 16チームがシード（1回戦免除でベスト32から参戦）
- ズッキュン中学（奈良）は1回戦から参加
- 週ごとの進行：
  - 1週目：1回戦（ベスト32決定）
  - 2週目：2回戦（ベスト16）
  - 3週目：3回戦（ベスト8）
  - 4週目：準々決勝
  - 5週目：準決勝
  - 6週目：決勝（相手は必ず「てぇでぇ's学園」）

## 3. チーム能力システム

### 3.1 能力値の種類
- **パスのスピード**: 1〜無限（初期値は`設定一覧.md`の`INITIAL_STATS`参照）
- **ドリブルのスピード**: 1〜無限（初期値は`設定一覧.md`の`INITIAL_STATS`参照）
- **シュートの強さ**: 1〜無限（初期値は`設定一覧.md`の`INITIAL_STATS`参照）

### 3.2 エースシステム
詳細は`設定一覧.md`の`ACE_SYSTEM`参照

#### 3.2.1 基本仕様
- 各チーム1試合勝利ごとにランダムで1人覚醒（GK除く）
- 能力倍率：1.5倍
- サイズ倍率：1.5倍
- 試合中、エースは大きく表示される

#### 3.2.2 エース覚醒画面
- 試合勝利後、リザルト画面の前に表示
- 表示内容：
  - 「（相手チーム名）に勝った。」
  - 「その勝利をきっかけに、（ポジション名）がエースに覚醒！」
- AIチームのエース覚醒はユーザーに通知しない

#### 3.2.3 ギアセカンドシステム
- 発動条件：全フィールドプレイヤー（GK除く6人）がエースに覚醒済み
- 能力倍率：2.0倍（エースの1.5倍からさらに強化）
- 覚醒方法：全員エース後、試合勝利時にランダムで1人ずつギアセカンドに覚醒
- 表示色：ピンク（#ff0066）で強調表示

#### 3.2.4 メイン画面での表示
- エース：「エース：CB、LW」のように短縮名で表示
- ギアセカンド：「ギアセカンド：P」のように短縮名で表示（1人以上いる場合のみ表示）

## 4. キャプテンシステム

詳細は`設定一覧.md`の`CAPTAIN_PERSONALITY`と`CAPTAIN_POLICY`参照

### 4.1 性格（3種類）
- パワハラ：高成長だがリスクあり
- 甘やかし：安定だが成長遅め
- 熱血：バランス型

### 4.2 方針（4種類）
- アグレッシブ：シュート重視
- 慎重：パス重視
- 目立ちたがり：ドリブル重視
- 論理的：弱点補強

## 5. 練習システム

詳細は`設定一覧.md`の`TRAINING_MENU`参照

### 5.1 練習メニュー
- パス練習：パス能力強化
- シュート練習：シュート能力強化
- ドリブル練習：ドリブル能力強化
- 総合練習：全能力バランス強化（端数切り捨てない）
- 休養：金曜日のみ選択可、次の試合で全能力ボーナス

### 5.2 「次の試合までは全てこの練習」機能
- **表示条件**: Round 3（3回戦）クリア後（currentRound >= 4）
- **利用可能日**: 月〜金曜日の練習日
- **対象メニュー**: パス、シュート、ドリブル、総合練習
- **機能**:
  - 現在の日から土曜日（試合日）までの全練習日を一括設定
  - 確認ダイアログで残り日数を表示
  - 実行後も個別の日は次週で変更可能
- **実装**: screens.js:269-297

### 5.3 成長計算
基本成長値 × キャプテン性格補正 × キャプテン方針補正

## 6. 試合システム

### 6.1 基本ルール
- **形式**: 攻撃のみ（守備は自動）
- **勝利条件**: `GAME_CONFIG.POINTS_TO_WIN`点先取
- **失点条件**:
  - パス/シュート失敗：1点失点
  - ドリブル失敗：1点失点
- **人数**: `GAME_CONFIG.PLAYERS_PER_TEAM`対`GAME_CONFIG.PLAYERS_PER_TEAM`

### 6.2 コート仕様
- **サイズ**: `GAME_CONFIG.COURT_WIDTH`×`GAME_CONFIG.COURT_HEIGHT`マス（ハンドボールコート半面）
- **ゴール**: 端の中央`GAME_CONFIG.GOAL_WIDTH`マス
- **初期配置**: `設定一覧.md`の`INITIAL_POSITIONS`参照

### 6.3 操作システム
1. **作戦立案フェーズ**:
   - 全ての動きを事前に設定
   - 例：「A→B（パス）、B（3秒ドリブル）→C（パス）、C→A（パス）、A（シュート）」
2. **実行フェーズ**:
   - 設定した作戦がリアルタイム実行（`GAME_CONFIG.FPS`fps）
   - 敵もリアルタイムで反応移動

### 6.4 行動選択肢
詳細は`設定一覧.md`の`ACTION_CONFIG`参照

### 6.5 成功判定とインターセプトメカニクス

#### 6.5.1 基本原則
- **インターセプトされた場合**: 成功率判定により突破可能
- **インターセプトされなかった場合**: 常に成功（ランダム失敗なし）

#### 6.5.2 成功率計算式
```
成功率 = (攻撃能力 / (攻撃能力 + 守備能力)) × 100
```
- パス: パス能力で判定
- シュート: シュート能力 × パワー倍率で判定
- ドリブル: ドリブル能力で判定

#### 6.5.3 弾かれアニメーション
インターセプトを突破した場合、敵プレイヤーが弾かれる：

**パス・シュート時**:
- 弾かれ方向: ボールの進行方向に対して相対的に315°（-45°）
- 弾かれ距離: 5%
- 復帰時間: 2秒でイーズアウトアニメーション

**ドリブル時**:
- 弾かれ方向: 敵が来た方向（ドリブラーから遠ざかる方向）
- 弾かれ距離: 5%
- 復帰時間: 2秒でイーズアウトアニメーション

#### 6.5.4 インターセプト判定
- **パス・シュート**: ボールの軌道に対して距離2%以内の敵プレイヤー
- **ドリブル**: ドリブラーから距離3%以内の敵プレイヤー
- **GK**: パス・シュートのインターセプトには参加しない

#### 6.5.5 敵GKの動き
- **動作**: ボール保持者のx座標を追跡
- **移動範囲**: x方向のみ（横方向）、y方向は固定（ゴールライン上）
- **制限**: ゴール枠内（42.5%〜57.5%）に制限、マージン1%
- **実装**: match.js:859-878

詳細な計算式は`設定一覧.md`の`SUCCESS_FORMULA`参照

## 7. 地方別作戦（守備パターン）

詳細は`設定一覧.md`の`REGIONAL_TACTICS`参照

### 主要地方の作戦
- **北海道**: 全員プレス（全員がボールホルダーに向かう）
- **東北**: マンツーマン（各選手マーク）
- **関東**: ゾーンディフェンス（エリア守備）
- **中部**: プレスディフェンス（前線圧力）
- **近畿**: バランス型（状況対応）
- **中国**: サイド守備重視
- **四国**: センター守備重視
- **九州**: 個人技重視（1対1）
- **K航拿**: 完全守備（最強の守備陣形）

## 8. 相手チーム能力値

詳細は`設定一覧.md`の`OPPONENT_STATS`参照
- ラウンドごとに段階的に強化
- 決勝の「てぇでぇ's学園」は最高能力値

## 9. UI/UX構成

### 9.1 画面構成
1. **タイトル画面**
   - ゲーム開始
   - 続きから

2. **メイン画面（日々のコマンド画面）**
   - 現在の日付表示（第N週 X曜日）
   - チーム能力値表示（パス、ドリブル、シュート）
   - エース表示：「エース：CB、LW」形式
   - ギアセカンド表示：「ギアセカンド：P」形式（1人以上いる場合のみ）
   - 休養ボーナス表示
   - 次の行動選択ボタン（練習/試合）
   - トーナメント表ボタン
   - リセットボタン

3. **練習画面**
   - 練習メニュー選択
   - 能力上昇予測表示
   - キャプテン情報表示
   - 「この練習をする」ボタン
   - 「次の試合までは全てこの練習」ボタン（Round 3クリア後のみ）

4. **作戦立案画面**
   - ラウンド名表示
   - 対戦相手情報（名前、地方、守備戦術）
   - **能力比較表示**：自チーム vs 相手チーム（パス、ドリブル、シュート）
   - 残りチャレンジ回数表示
   - 作戦設定UI
   - 作戦リスト（失敗した作戦は赤く表示）
   - 試合開始ボタン

5. **試合画面**
   - スコア表示（自チーム - 相手チーム）
   - **能力比較表示**：自チーム vs 相手チーム（常時表示）
   - コート表示（上から見下ろし）
   - 選手配置（丸いアイコン、エースは1.5倍、ギアセカンドはピンク色）
   - パス/シュートルート表示（線）
   - インターセプトオーバーレイ表示

6. **エース覚醒画面**（試合勝利後）
   - 勝利メッセージ：「（相手チーム名）に勝った。」
   - 覚醒メッセージ：「その勝利をきっかけに、（ポジション名）がエース/ギアセカンドに覚醒！」
   - 次へボタン

7. **結果画面**
   - 勝敗表示
   - 得失点表示
   - トーナメント進行状況
   - 次週へ進むボタン

### 9.2 視覚表現
- **試合表示**: サカつく簡易表示風
- **選手**: 丸いアイコン（エースは1.5倍サイズ、ギアセカンドはピンク色で2.0倍の能力）
- **パスルート**: 破線表示
- **シュートルート**: 実線表示
- **弾かれアニメーション**: インターセプト突破時、敵プレイヤーが5%弾かれて2秒で戻る
- **GK動作**: ボール保持者のx座標に追従して横移動
- **背景画像**: 後から挿入可能な仕様（CSSで背景設定）

## 10. その他の仕様

### 10.1 他校の試合
- 自動計算で結果決定
- 能力値とランダム要素で勝敗判定

### 10.2 データ保存
- LocalStorage使用
- 保存データ：
  - 現在の週
  - 現在の曜日
  - チーム能力値（パス、ドリブル、シュート）
  - キャプテン情報（性格、方針）
  - トーナメント進行状況（currentRound、results）
  - エース情報（aces配列：位置インデックス）
  - ギアセカンド情報（gearSecond配列：位置インデックス）
  - 休養ボーナス状態
  - 週間練習履歴

### 10.3 リセマラ
- ゲーム開始時のみ可能
- LocalStorageクリア＋再ロード

## 11. 技術仕様

### 11.1 開発環境
- HTML5 + CSS3 + JavaScript
- フレームワーク：なし（Pure JavaScript）
- アニメーション：requestAnimationFrame（30fps）

### 11.2 対応ブラウザ
- iOS Safari
- Android Chrome
- その他モダンブラウザ

### 11.3 画面サイズ
- レスポンシブ対応
- スマホ縦向き最適化

## 12. 今後の拡張余地
- 背景画像の追加
- 効果音・BGMの追加
- 選手個別能力の追加
- 守備フェーズの追加
- オンライン対戦機能

## 13. 実装済み機能と技術詳細

### 13.1 主要実装ファイル
- **match.js**: 試合シミュレーション、インターセプトメカニクス、弾かれアニメーション
- **screens.js**: 全画面レンダリング、エース覚醒画面、能力比較表示
- **gameState.js**: ゲーム状態管理、エース・ギアセカンド覚醒処理
- **teams.js**: チーム生成、AI試合シミュレーション
- **config.js**: 全設定値の一元管理

### 13.2 最近の主要実装（2025年11月）

#### インターセプトメカニクスの全面改修
- 成功率判定システム（match.js:408-463, 512-583, 417-428）
- 弾かれアニメーション（Player.knockback()メソッド）
- イーズアウト復帰アニメーション（2秒）

#### エース・ギアセカンドシステム
- エース覚醒画面（screens.js:1318-1340）
- メイン画面でのポジション表示（screens.js:106-129）
- ギアセカンド覚醒判定（gameState.js:336-395）

#### 能力比較UI
- 作戦立案画面（screens.js:295-324）
- 試合中画面（screens.js:1090-1119）

#### 練習システム拡張
- 「次の試合までは全てこの練習」ボタン（screens.js:269-297）
- Round 3クリア後に有効化

#### 敵GK AI
- x方向のみの移動（match.js:859-878）
- ゴール枠内に制限

### 13.3 座標系とスケール
- パーセンテージ座標系（0-100%）
- COART.svgベース（20000単位 = 20m）
- ゴール枠：42.5%-57.5%（x方向）、y=0%（ゴールライン）

## 14. 開発優先順位
1. ✅ 基本的なゲームループ（練習→試合→結果）
2. ✅ 試合システムの実装
3. ✅ トーナメント進行
4. ✅ UI/UXのブラッシュアップ
5. ✅ エフェクト・演出の追加
6. 🔄 バランス調整・バグフィックス

---

**注意事項**:
- この仕様書は開発開始前の最終版です
- 実装中に技術的制約により微調整が入る可能性があります
- 背景画像は後から追加できる設計にすること
- **全てのパラメータと数値設定は「設定一覧.md」から読み込むこと**
- **ハードコーディングは禁止、必ずconfig.jsを経由して値を参照すること**